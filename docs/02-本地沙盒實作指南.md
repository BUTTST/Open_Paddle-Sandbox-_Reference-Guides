# 本地沙盒實作指南（Next.js + Paddle v2）

> 本指南說明開源專案在本地以 Paddle Sandbox 環境運行的完整步驟：需要準備哪些參數、要修改哪些檔案、如何啟動本地伺服器、如何將本地暴露至公網以測試 Webhook，以及 VSCode/Cursor 的 HTML/Markdown 預覽工具建議。

---

## ⚠️ 文檔免責聲明

**本指南由 AI 生成並經人工重點審閱。  
雖然已盡力確保準確性，但仍可能存在偏差或錯誤，  
請自行驗證並以實際操作結果為準。**

---

## 📋 目錄
1. [準備與參數填寫表](#1%EF%B8%8F⃣-準備與參數填寫表)
2. [需要修改的檔案與參數位置](#2%EF%B8%8F⃣-需要修改的檔案與參數位置)
3. [安裝與啟動（本地 Sandbox）](#3%EF%B8%8F⃣-安裝與啟動本地-sandbox)
4. [將本地暴露到公網（Webhook/結帳回調）](#4%EF%B8%8F⃣-將本地暴露到公網webhook結帳回調)
5. [HTML/Markdown 預覽（VSCode/Cursor）](#5%EF%B8%8F⃣-htmlmarkdown-預覽vscodecursor)
6. [常見問題（Sandbox）](#6%EF%B8%8F⃣-常見問題sandbox)
7. [相關文檔](#7%EF%B8%8F⃣-相關文檔)

---

## 1️⃣ 準備與參數填寫表

在開始前，請先於 01 完成參數取得；以下表格供你在本地測試時填寫，並附上對應 01 的捷徑連結：

| 參數 | 你的值 | 來源連結（對應 01 段落） | 備註 |
|------|------|----------------------------|------|
| NEXT_PUBLIC_PADDLE_CLIENT_TOKEN |  | [6.2 Client-side Token](./01-Paddle完整設定指南.md#62-client-side-token客戶端-token) | Sandbox 用 `test_` 前綴；可公開於前端 |
| NEXT_PUBLIC_PADDLE_PRICE_ID |  | [3.4 取得 Price ID 和 Product ID](./01-Paddle完整設定指南.md#34-取得-price-id-和-product-id) | 結帳用 `pri_` 前綴 |
| （選）Product ID |  | [3.4 取得 Price ID 和 Product ID](./01-Paddle完整設定指南.md#34-取得-price-id-和-product-id) | 部分後端 API 需用到 |
| （選）Vendor ID |  | [5.1 Vendor ID](./01-Paddle完整設定指南.md#51-vendor-id供應商識別碼) | v1 才需；v2 前端不需 |
| （選）Seller ID |  | [5.2 Seller ID](./01-Paddle完整設定指南.md#52-seller-id) | 少數 API 文件會用到 |
| （選）PADDLE_API_KEY |  | [6.1 新增-獲取 API Key](./01-Paddle完整設定指南.md#61-新增-獲取api-keyapi-金鑰) | 僅伺服器端使用，勿加 `NEXT_PUBLIC_` |

> 提醒：若你尚未取得以上參數，請先依 01《Paddle 完整設定指南》操作完成後再回到此頁。

---

## 2️⃣ 需要修改的檔案與參數位置

本專案預設即支援 Sandbox；你主要需要確認以下兩處：

- 前端 Token 初始化（已讀取環境變數）

```1:24:Open_Paddle_Reference-Guides/src/components/PaddleLoader.tsx
'use client';

import Script from 'next/script';

export default function PaddleLoader() {
  return (
    <Script
      src="https://cdn.paddle.com/paddle/v2/paddle.js"
      strategy="afterInteractive"
      onLoad={() => {
        const token = process.env.NEXT_PUBLIC_PADDLE_CLIENT_TOKEN || 'test_1a2b3c4d5e6f7g8h9i0j1k2l3m4n5o';
        (window as any).Paddle?.Environment?.set('sandbox');
        (window as any).Paddle?.Initialize?.({ token });
      }}
    />
  );
}
```

- 結帳所用的 Price ID（目前為範例常數，請改為你的 `pri_...`）

```5:19:Open_Paddle_Reference-Guides/src/app/page.tsx
// 替換為你在 Paddle Catalog 建立的 Price ID
// 格式：pri_ 開頭 + 27 位小寫英數字
const PRICE_ID = 'pri_01abc2def3ghi4jkl5mno6pqr7s';

export default function Page() {
  const onBuy = () => {
    const Paddle = (window as any).Paddle;
    if (!Paddle?.Checkout?.open) {
      console.error('Paddle v2 尚未載入');
      return;
    }
    Paddle.Checkout.open({
      items: [{ priceId: PRICE_ID }],
    });
  };
```

> 可選作法：若希望從環境變數讀取價格，可自行將上述常數改為 `process.env.NEXT_PUBLIC_PADDLE_PRICE_ID!`。

---

## 3️⃣ 安裝與啟動（本地 Sandbox）

1. 安裝必要環境（建議）
   - Node.js ≥ 18.18（建議使用 20 LTS）
   - Git、PowerShell 7（Windows）
   - VSCode 或 Cursor

2. 安裝依賴
   ```bash
   npm install
   ```

3. 建立環境變數檔（從 env.example 複製）
   ```bash
   cp Open_Paddle_Reference-Guides/env.example Open_Paddle_Reference-Guides/.env.local
   ```
   - 編輯 `.env.local`，填入「1️⃣ 準備與參數填寫表」中你的值：
   ```env
   NEXT_PUBLIC_PADDLE_ENV=sandbox
   NEXT_PUBLIC_PADDLE_CLIENT_TOKEN=test_你的SandboxToken
   NEXT_PUBLIC_PADDLE_PRICE_ID=pri_你的SandboxPriceId
   # 伺服器端（選）：
   # PADDLE_API_KEY=apikey_...
   # PADDLE_WEBHOOK_SECRET=whsec_...
   ```
   - 若你在開源版本看到檔名為 `本地.env.local`（為避免 IDE 鎖定而加的前綴），請將其重新命名為 `.env.local` 才會生效。

5. （可選）使用提供的本地範例檔
   - 專案提供 `本地.env` 與 `本地.env.local`（皆為模擬值），你可以：
     - 直接改名為 `.env` / `.env.local` 使用，或
     - 將內容複製到你的 `.env.local` 中
   - 提醒：`.env` 並非 Next.js 必要，建議主要使用 `.env.local`

4. 啟動本地開發伺服器
   ```bash
   npm run dev
   # 於瀏覽器開啟 http://localhost:3000
   ```

---

## 4️⃣ 將本地暴露到公網（Webhook/結帳回調）

若你要測試 Webhook 或第三方回調，需暫時將本機 3000 埠暴露至公網：

- localtunnel（簡單快速）
  ```bash
  npx localtunnel --port 3000
  # 會得到一個 URL，例如：https://xxxx.loca.lt
  ```

- cloudflared（穩定、免費）
  ```bash
  npx cloudflared tunnel --url http://localhost:3000
  ```

- ngrok（常見方案）
  ```bash
  ngrok http 3000
  ```

完成後，可在 Paddle Dashboard → Developer Tools → Notifications 中設定 Webhook URL，指向：

```
https://你的公開隧道域名/api/webhook
```

> Webhook 驗證與事件處理請參考：[05-Webhook事件處理指南](./05-Webhook事件處理指南.md)

---

## 5️⃣ HTML/Markdown 預覽（VSCode/Cursor）

- HTML Go Live：
  - VSCode 擴充：`Live Server`（ID: ritwickdey.LiveServer）
  - VSCode 官方：`Live Preview`（ID: ms-vscode.live-server）
  - 使用方式：在 HTML 檔點右鍵「Open with Live Server」

- Markdown 文件：
  - VSCode 內建「Open Preview」（或擴充 `Markdown Preview Enhanced`）
  - Cursor 亦支援 Markdown 即時預覽

> 提醒：本專案是 Next.js，啟動 `npm run dev` 後即有完整網頁預覽，一般不需額外 HTML Go Live。

---

## 6️⃣ 常見問題（Sandbox）

- 看不到結帳視窗？
  - 確認 `NEXT_PUBLIC_PADDLE_CLIENT_TOKEN` 是否為 `test_` 前綴且有效
  - 確認 `PRICE_ID` 是否為 Sandbox 的 `pri_`，且對應的 Product/Price 已啟用

- Webhook 沒有打到本地？
  - 確認隧道工具連線中且 URL 正確
  - 確認目標路徑 `/api/webhook` 無 404，詳見 `src/app/api/webhook/route.ts`
  - 驗證簽章請改看 [05-Webhook事件處理指南](./05-Webhook事件處理指南.md)

---

## 7️⃣ 相關文檔

- 參數取得與設定總覽：[01-Paddle完整設定指南](./01-Paddle完整設定指南.md)
- Webhook 詳細處理與驗證：[05-Webhook事件處理指南](./05-Webhook事件處理指南.md)

---

**文檔版本**：v3.0.0  
**最後更新**：2025-10-05  
**說明**：重寫為本地 Sandbox 實作指南

