# 沙盒環境轉生產環境完整指南

> 本指南詳細說明如何從測試環境切換到正式環境，包含身份驗證、網域核准等完整流程

---

## 📋 目錄
1. [切換前準備工作](#1%EF%B8%8F⃣-切換前準備工作)
2. [Paddle 帳號身份驗證（KYC）](#2%EF%B8%8F⃣-paddle-帳號身份驗證kyc)
3. [網域核准申請](#3%EF%B8%8F⃣-網域核准申請domain-approval)
4. [重新建立產品與價格](#4%EF%B8%8F⃣-重新建立產品與價格)
5. [程式碼環境切換](#5%EF%B8%8F⃣-程式碼環境切換)
6. [Webhook 設定與驗證](#6%EF%B8%8F⃣-webhook-設定與驗證)
7. [測試與驗收](#7%EF%B8%8F⃣-測試與驗收)
8. [上線檢查清單](#8%EF%B8%8F⃣-上線檢查清單)

---

## 1️⃣ 切換前準備工作

### 1.1 環境差異理解

**Sandbox（沙盒環境）與 Production（正式環境）的差異**：

| 項目 | Sandbox | Production |
|------|---------|-----------|
| 交易狀態 | 測試交易，不會實際扣款 | 真實交易，會實際扣款 |
| 測試卡號 | 可使用 `4242 4242 4242 4242` 等 | 不可使用測試卡號 |
| Vendor ID | 獨立的測試 ID | 獨立的正式 ID |
| Token 前綴 | `test_` | `live_` |
| Price ID | 獨立的測試 Price | 獨立的正式 Price |
| Domain Approval | **不需要** | **必須申請** |
| 身份驗證 | 簡化流程 | 需提供護照/身分證等文件 |
| Webhook 簽章 | 建議驗證但非強制 | **強制驗證** |
| 資料互通 | ❌ 完全獨立 | ❌ 完全獨立 |

> ⚠️ **重要**：Sandbox 和 Production 是完全獨立的兩個環境，所有設定、產品、客戶資料都不互通！

---

### 1.2 準備事項

在開始切換前，請準備好以下資料與文件：

#### A. 公司/個人資料
- [ ] 公司名稱（或個人全名）
- [ ] 公司註冊地址（或個人居住地址）
- [ ] 稅號（Tax ID / VAT Number / EIN）
- [ ] 聯絡電話
- [ ] 官方郵箱

#### B. 身份驗證文件
- [ ] **護照**（Passport）或
- [ ] **身分證**（National ID Card）或
- [ ] **駕照**（Driver's License）

> 💡 **提示**：
> - 文件必須是彩色掃描件或清晰照片
> - 有效期限內
> - 四個角落完整可見

#### C. 網站資訊
- [ ] 正式網域（Domain）：例如 `yourdomain.com`
- [ ] 網站必須已上線且可訪問
- [ ] 網站必須有明確的產品/服務說明
- [ ] 隱私政策（Privacy Policy）頁面
- [ ] 服務條款（Terms of Service）頁面
- [ ] 退款政策（Refund Policy）頁面

> ⚠️ **要求**：Paddle 會人工審核你的網站，確保符合規範

---

## 2️⃣ Paddle 帳號身份驗證（KYC）

### 2.1 什麼是 KYC？

**KYC（Know Your Customer）**：金融服務提供者必須驗證客戶身份的程序

**為什麼需要 KYC？**
- 防止洗錢（AML - Anti-Money Laundering）
- 符合國際金融法規
- 保護買賣雙方權益

---

### 2.2 開始驗證流程

**操作步驟**：

1. 登入 **Production** Paddle Dashboard（注意：不是 Sandbox）
   - 網址：https://vendors.paddle.com/

2. 登入後，系統可能會自動提示你完成驗證

3. 或者，前往 **Account Settings（帳號設定）** → **Verification（驗證）**

![KYC 入口](./images/domain-approval/kyc-entry.png)

> 📸 **截圖內容**：Dashboard 上的 KYC 提示或驗證入口

---

### 2.3 填寫公司/個人資訊

**要填寫的欄位**：

| 欄位 | 說明 | 範例 |
|------|------|------|
| Business Name | 公司名稱（或個人名稱） | `ABC Tech Ltd.` |
| Business Address | 公司地址 | `123 Main St, City, Country` |
| Tax ID | 稅號 | `12-3456789` |
| Phone Number | 聯絡電話 | `+886-2-1234-5678` |
| Email | 官方郵箱 | `contact@yourdomain.com` |

**操作步驟**：

1. 逐一填寫所有必填欄位

2. 確認所有資訊正確無誤

3. 點擊 **「Continue」** 或 **「Save」**

![填寫公司資訊](./images/domain-approval/business-info.png)

> 📸 **截圖內容**：公司資訊填寫表單

---

### 2.4 上傳身份證明文件

**可接受的文件類型**：
- 護照（Passport）
- 身分證（National ID）
- 駕照（Driver's License）

**上傳要求**：

| 要求 | 說明 |
|------|------|
| 格式 | JPG、PNG、PDF |
| 檔案大小 | 通常 10MB 以內 |
| 清晰度 | 所有文字清晰可辨識 |
| 完整性 | 四個角落完整可見 |
| 有效期 | 必須在有效期限內 |

**操作步驟**：

1. 點擊 **「Upload document」** 或 **「選擇檔案」**

2. 選擇已準備好的文件掃描件

3. 上傳完成後，預覽確認清晰度

4. 點擊 **「Submit」** 提交

![上傳身份文件](./images/domain-approval/upload-document.png)

> 📸 **截圖內容**：文件上傳介面

---

### 2.5 等待審核

**審核時間**：
- 通常 **3-7 個工作天**
- 高峰期可能更久
- Paddle 會透過郵件通知審核結果

**審核期間你可以做什麼**：
- 繼續建立產品（Draft 狀態）
- 繼續開發程式碼
- 申請 Domain Approval（可同時進行）

**審核結果**：

| 結果 | 說明 | 下一步 |
|------|------|-------|
| ✅ 通過 | 恭喜！可以開始收款 | 繼續其他設定 |
| ⚠️ 需要補充資料 | Paddle 會郵件通知缺少什麼 | 補充資料後重新提交 |
| ❌ 拒絕 | 不符合 Paddle 使用條款 | 聯絡 Paddle 支援詢問原因 |

---

## 3️⃣ 網域核准申請（Domain Approval）

### 3.1 什麼是 Domain Approval？

**網域核准（Domain Approval）**：Paddle 必須驗證並核准你的網域，才能在該網域上顯示結帳介面

**為什麼需要？**
- 防止釣魚網站濫用
- 確保品牌安全
- 符合 PCI DSS 安全標準

**Sandbox vs Production**：

| 環境 | 是否需要 Domain Approval |
|------|------------------------|
| Sandbox | ❌ 不需要 |
| Production | ✅ **必須** |

---

### 3.2 申請網域核准

**操作步驟**：

1. 登入 Production Paddle Dashboard

2. 左側選單 → **Developer Tools** → **Domain Approval**

3. 點擊 **「Add domain」** 或 **「+ New domain」**

4. 輸入你的網域（不含 `https://` 和路徑）：
   - ✅ 正確：`yourdomain.com`
   - ❌ 錯誤：`https://yourdomain.com/checkout`

5. 點擊 **「Submit」** 提交申請

![Domain Approval 申請](./images/domain-approval/add-domain.png)

> 📸 **截圖內容**：
> - Domain Approval 頁面
> - Add domain 按鈕
> - 輸入網域的欄位

---

### 3.3 網域要求

**Paddle 會檢查你的網站是否符合以下要求**：

#### A. 網站必須已上線
- [ ] 網站可正常訪問（不能是 404 或建設中頁面）
- [ ] 有明確的產品/服務介紹
- [ ] 設計專業，不像詐騙網站

#### B. 必須有法律頁面
- [ ] **Privacy Policy（隱私政策）**：說明如何處理用戶資料
- [ ] **Terms of Service（服務條款）**：使用條款
- [ ] **Refund Policy（退款政策）**：退款規則

> 💡 **法律頁面範例**：
> - https://yourdomain.com/privacy
> - https://yourdomain.com/terms
> - https://yourdomain.com/refund

#### C. 聯絡方式
- [ ] 必須有明確的聯絡方式（郵箱、表單或電話）

#### D. 內容合規
- [ ] 不得銷售違禁品（武器、毒品、賭博等）
- [ ] 不得有誤導性內容
- [ ] 符合 Paddle 使用條款

---

### 3.4 等待審核

**審核時間**：
- 通常 **3-7 個工作天**
- 高峰期可能 **1-2 週**
- Paddle 會人工審核你的網站

> ⚠️ **建議**：提前 **2 週以上** 申請！

**審核狀態**：

| 狀態 | 說明 |
|------|------|
| `Pending` | 審核中 |
| `Approved` | 已核准，可以使用 |
| `Rejected` | 被拒絕，需修正後重新申請 |

**如何查看狀態**：

1. Developer Tools → Domain Approval

2. 查看網域旁的狀態標籤

![Domain 狀態](./images/domain-approval/domain-status.png)

> 📸 **截圖內容**：Domain 列表及狀態標籤

---

### 3.5 審核被拒怎麼辦？

**常見拒絕原因**：

| 原因 | 解決方法 |
|------|---------|
| 缺少隱私政策 | 新增 Privacy Policy 頁面 |
| 缺少退款政策 | 新增 Refund Policy 頁面 |
| 網站建設中 | 完成網站開發後重新申請 |
| 內容不符規範 | 修改內容，確保合規 |
| 無法訪問 | 檢查網站是否正常運行 |

**重新申請步驟**：

1. 根據 Paddle 郵件中的反饋修正網站

2. 回到 Domain Approval 頁面

3. 重新提交申請

4. 在申請表單中說明已修正的內容

---

## 4️⃣ 重新建立產品與價格

### 4.1 為什麼要重新建立？

**Sandbox 和 Production 的產品完全獨立**，無法直接匯入或同步。

你必須在 Production 環境中重新建立所有產品和價格。

---

### 4.2 建立步驟

請參考 **[01-產品新增指南](./01-產品新增指南.md)** 的詳細步驟。

**注意事項**：
- 產品名稱、價格可以與 Sandbox 相同
- 但 **Price ID 會完全不同**
- 記得記錄新的 Price ID

---

### 4.3 參數對照表

建議建立一個對照表，方便切換環境：

| 項目 | Sandbox 值 | Production 值 |
|------|-----------|--------------|
| Environment | `sandbox` | `production` |
| Client Token | `test_7a8b...`（模擬數值） | `live_9x8y...`（模擬數值） |
| API Key | `apikey_...`（測試） | `apikey_...`（正式） |
| Price ID（基本方案） | `pri_...`（測試） | `pri_...`（正式） |
| Price ID（進階方案） | `pri_...`（測試） | `pri_...`（正式） |

---

## 5️⃣ 程式碼環境切換

### 5.1 環境變數更新

**修改 `.env.local` 或 `.env.production`**：

```env
# === Paddle Production 配置 ===

# 環境：從 sandbox 改為 production
NEXT_PUBLIC_PADDLE_ENV=production

# Client-side Token：從 test_ 改為 live_
NEXT_PUBLIC_PADDLE_CLIENT_TOKEN=live_你的正式Token

# （伺服器端）API Key：使用正式環境的 Key
PADDLE_API_KEY=apikey_你的正式Key

# Price ID（如果有使用環境變數）
NEXT_PUBLIC_PADDLE_PRICE_ID=pri_你的正式PriceID
```

> ⚠️ **重要**：更新後必須重新啟動開發伺服器！

---

### 5.2 前端程式碼調整

#### A. 移除 Sandbox 設定

**Before（Sandbox）**：
```typescript
// components/PaddleLoader.tsx
Paddle.Environment.set('sandbox');  // ❌ 移除這一行
Paddle.Initialize({ 
  token: process.env.NEXT_PUBLIC_PADDLE_CLIENT_TOKEN 
});
```

**After（Production）**：
```typescript
// components/PaddleLoader.tsx
// 不需要設定 Environment（預設就是 production）
Paddle.Initialize({ 
  token: process.env.NEXT_PUBLIC_PADDLE_CLIENT_TOKEN  // 使用 live_ token
});
```

---

#### B. 更新 Price ID

**Before（Sandbox）**：
```typescript
// app/page.tsx
const PRICE_ID = 'pri_89a4bcd5ef678gh9ij0klm1nop2';  // Sandbox Price（模擬數值）
```

**After（Production）**：
```typescript
// app/page.tsx
const PRICE_ID = 'pri_12x3yz45ab678cd9ef0gh1ij2kl';  // Production Price（模擬數值）
```

> 💡 **建議**：將 Price ID 也放到環境變數中，方便管理：

```env
# .env.local
NEXT_PUBLIC_PADDLE_PRICE_ID=pri_你的正式PriceID
```

```typescript
// app/page.tsx
const PRICE_ID = process.env.NEXT_PUBLIC_PADDLE_PRICE_ID!;
```

---

### 5.3 Webhook 簽章驗證（必須實作）

**為什麼需要？**
- 防止惡意偽造 Webhook 通知
- 確保通知確實來自 Paddle

**實作方式**：

```typescript
// app/api/webhook/route.ts
import { NextRequest, NextResponse } from 'next/server';
import crypto from 'crypto';

// 從 Paddle 取得的 Webhook Secret
const WEBHOOK_SECRET = process.env.PADDLE_WEBHOOK_SECRET!;

export async function POST(req: NextRequest) {
  try {
    const body = await req.json();
    const signature = req.headers.get('paddle-signature');
    
    // 驗證簽章
    if (!verifyWebhookSignature(body, signature, WEBHOOK_SECRET)) {
      return NextResponse.json(
        { error: 'Invalid signature' }, 
        { status: 401 }
      );
    }
    
    // 簽章驗證通過，處理事件
    const eventType = body.alert_name || body.event_type;
    
    switch(eventType) {
      case 'subscription_created':
        // 處理訂閱建立
        break;
      // ... 其他事件
    }
    
    return NextResponse.json({ success: true });
  } catch (err) {
    console.error('Webhook error:', err);
    return NextResponse.json(
      { error: 'Internal error' }, 
      { status: 500 }
    );
  }
}

// 簽章驗證函式（參考 Paddle 官方文件實作）
function verifyWebhookSignature(
  body: any, 
  signature: string | null, 
  secret: string
): boolean {
  if (!signature) return false;
  
  // 實作簽章驗證邏輯（依 Paddle 文件）
  // 這裡需要根據 Paddle 官方文件實作具體驗證邏輯
  
  return true;
}
```

> 💡 **詳細實作請參考**：[05-Webhook事件處理指南](./05-Webhook事件處理指南.md)

---

## 6️⃣ Webhook 設定與驗證

### 6.1 設定正式 Webhook URL

**操作步驟**：

1. Paddle Dashboard → **Developer Tools** → **Notifications**

2. 找到 **「Notification Settings」** 或 **「Webhook endpoints」**

3. 點擊 **「Add endpoint」** 或 **「+」**

4. 輸入你的正式 Webhook URL：
   ```
   https://yourdomain.com/api/webhook
   ```

5. 選擇要訂閱的事件類型（建議全部勾選）：
   - ✅ `subscription.created`
   - ✅ `subscription.updated`
   - ✅ `subscription.cancelled`
   - ✅ `transaction.completed`
   - ✅ `transaction.updated`
   - ✅ （其他所有相關事件）

6. 點擊 **「Save」** 儲存

![設定 Webhook](./images/webhook/add-endpoint.png)

> 📸 **截圖內容**：
> - Notifications 設定頁面
> - Add endpoint 按鈕
> - 事件類型勾選清單

---

### 6.2 測試 Webhook

**測試方法 A：使用 Paddle Simulator**

1. Developer Tools → **Notifications** → **Simulations**（或 **Test**）

2. 選擇事件類型（例如 `subscription.created`）

3. 輸入你的 Webhook URL

4. 點擊 **「Send test」**

5. 檢查你的伺服器日誌是否收到通知

---

**測試方法 B：進行實際測試交易**

1. 使用真實信用卡進行小額交易（例如 $0.50 USD）

2. 觀察 Webhook 是否正確接收

3. 測試完成後可申請退款

> ⚠️ **注意**：Production 環境無法使用測試卡號

---

## 7️⃣ 測試與驗收

### 7.1 完整測試流程

**測試清單**：

#### A. 前端結帳測試
- [ ] 結帳按鈕可正常點擊
- [ ] Paddle Overlay 正常彈出
- [ ] 價格與產品名稱顯示正確
- [ ] 可正常填寫付款資訊
- [ ] 可成功完成付款

#### B. Webhook 測試
- [ ] Webhook 簽章驗證正常
- [ ] `subscription_created` 事件正確處理
- [ ] `transaction.completed` 事件正確處理
- [ ] 錯誤處理機制正常（例如簽章錯誤時拒絕請求）

#### C. 後台管理測試
- [ ] Paddle Dashboard 中可看到交易紀錄
- [ ] 訂閱狀態顯示正確
- [ ] 可正常進行退款操作

---

### 7.2 小額測試建議

**進行小額真實交易測試**：

1. 設定一個低價測試商品（例如 $0.50 USD）

2. 使用真實信用卡完成付款

3. 驗證整個流程：
   - 結帳成功
   - Webhook 接收正常
   - Dashboard 顯示交易

4. 測試完成後申請退款（在 Dashboard 中操作）

> 💡 **提示**：小額測試可以最低成本驗證整個流程

---

## 8️⃣ 上線檢查清單

### 8.1 最終確認清單

**在正式上線前，請逐一確認以下所有項目**：

#### A. Paddle 平台設定
- [ ] KYC 身份驗證已通過
- [ ] Domain Approval 已核准
- [ ] 所有產品與價格已建立（Production 環境）
- [ ] Webhook URL 已正確設定
- [ ] 已訂閱所有必要的 Webhook 事件

#### B. 程式碼設定
- [ ] 環境變數已切換為 Production
  - [ ] `NEXT_PUBLIC_PADDLE_ENV=production`
  - [ ] `NEXT_PUBLIC_PADDLE_CLIENT_TOKEN` 使用 `live_` 開頭
  - [ ] `PADDLE_API_KEY` 使用正式環境 Key
- [ ] 所有 Price ID 已更新為 Production 的 ID
- [ ] 已移除 `Paddle.Environment.set('sandbox')`
- [ ] Webhook 簽章驗證已實作
- [ ] 錯誤處理與日誌記錄完善

#### C. 安全性
- [ ] API Key 未暴露在前端程式碼
- [ ] `.env.local` 已加入 `.gitignore`
- [ ] Webhook 簽章驗證已啟用
- [ ] HTTPS 已啟用（Paddle 要求）

#### D. 法律與合規
- [ ] 隱私政策頁面已上線
- [ ] 服務條款頁面已上線
- [ ] 退款政策頁面已上線
- [ ] 結帳頁面有明確的計費說明

#### E. 測試驗證
- [ ] 已完成至少一次小額真實交易測試
- [ ] Webhook 接收與處理正常
- [ ] 退款流程測試通過
- [ ] 在不同瀏覽器測試正常

---

### 8.2 上線後監控

**持續監控以下項目**：

1. **交易成功率**
   - 在 Paddle Dashboard → Reports 查看

2. **Webhook 接收狀況**
   - 監控伺服器日誌
   - 設定告警（例如 Webhook 失敗通知）

3. **錯誤日誌**
   - 監控前端錯誤（例如使用 Sentry）
   - 監控後端錯誤

4. **用戶反饋**
   - 注意客服回報的付款問題

---

## 🎉 恭喜完成切換！

你已經成功將 Paddle 整合從沙盒環境切換到正式環境！

**後續建議**：

- 定期檢視交易報表
- 關注 Paddle 的更新公告
- 持續優化結帳流程
- 收集用戶反饋並改進

---

## 🔗 相關文檔

- [01-產品新增指南](./01-產品新增指南.md)
- [02-Paddle平台參數說明](./02-Paddle平台參數說明.md)
- [04-常見問題與除錯](./04-常見問題與除錯.md)
- [05-Webhook事件處理指南](./05-Webhook事件處理指南.md)

---

**文檔版本**：v1.0.0  
**最後更新**：2025-10-01  
**實測日期**：2025-09-30

