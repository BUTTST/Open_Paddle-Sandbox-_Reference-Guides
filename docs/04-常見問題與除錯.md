# 常見問題與除錯指南

> 本文檔整理了使用 Paddle Billing v2 時最常遇到的問題與解決方法

---

## ⚠️ 文檔免責聲明

**本指南全文由 AI 生成，「無人工審閱」  
雖然已盡力確保準確性，但仍可能存在偏差或錯誤，  
請自行驗證並以實際操作結果為準。**

---

## 📋 目錄
1. [前端結帳問題](#1%EF%B8%8F⃣-前端結帳問題)
2. [HTTP 錯誤碼問題](#2%EF%B8%8F⃣-http-錯誤碼問題)
3. [Webhook 問題](#3%EF%B8%8F⃣-webhook-問題)
4. [環境切換問題](#4%EF%B8%8F⃣-環境切換問題)
5. [付款失敗問題](#5%EF%B8%8F⃣-付款失敗問題)
6. [除錯工具與技巧](#6%EF%B8%8F⃣-除錯工具與技巧)

---

## 1️⃣ 前端結帳問題

### Q1：點擊按鈕沒有反應

**症狀**：
- 點擊「Buy my product」按鈕後沒有任何反應
- Paddle Overlay 沒有彈出

**可能原因**：
- Paddle 腳本尚未載入完成
- Price ID 未正確設置
- JavaScript 執行錯誤

**解決方法**：

1. **開啟瀏覽器開發者工具**：
   - Windows / Linux：按 `F12`
   - macOS：按 `Cmd + Option + I`

2. **切換到 Console（控制台）分頁**

3. **查看是否有紅色錯誤訊息**

4. **在 Console 輸入以下指令檢查 Paddle 物件**：
   ```javascript
   window.Paddle
   ```
   - 如果顯示 `undefined`，表示 Paddle 腳本未載入

5. **檢查 Price ID 是否正確**：
   ```typescript
   // app/page.tsx
   const PRICE_ID = 'pri_...';  // 必須是有效的 Price ID
   ```

6. **確認 Paddle 初始化程式碼**：
   ```typescript
   // components/PaddleLoader.tsx
   Paddle.Initialize({ token: '你的Token' });
   ```

---

### Q2：Overlay 顯示「Something went wrong」

**症狀**：
- Paddle 結帳視窗有彈出
- 但顯示錯誤訊息「Something went wrong」

**可能原因**：
- Token 未正確設置
- Price ID 不存在或無效
- 環境設定錯誤（Sandbox vs Production）

**解決方法**：

1. **檢查 Network 標籤**：
   - F12 → Network
   - 找到失敗的請求（通常是紅色）
   - 點擊查看 Response

2. **常見錯誤訊息**：

| 錯誤訊息 | 原因 | 解決方法 |
|---------|------|---------|
| `paddle-clienttoken header is missing` | Token 未正確初始化 | 檢查 `Paddle.Initialize({ token: '...' })` |
| `Price not found` | Price ID 不存在 | 確認 Price ID 正確且已建立 |
| `Invalid environment` | 環境不匹配 | 檢查是否用 Sandbox Token 訪問 Production Price |

3. **確認環境匹配**：
   - Sandbox Token（`test_`） + Sandbox Price ID（`pri_...`）
   - Production Token（`live_`） + Production Price ID（`pri_...`）

---

### Q3：結帳視窗語言不正確

**症狀**：
- Paddle Overlay 顯示的語言不是預期的語言

**解決方法**：

可以在初始化時設定語言：

```typescript
Paddle.Initialize({ 
  token: '你的Token',
  locale: 'zh-TW'  // 繁體中文
});
```

支援的語言代碼：
- `en`：英文
- `zh-CN`：簡體中文
- `zh-TW`：繁體中文
- `ja`：日文
- `ko`：韓文

---

## 2️⃣ HTTP 錯誤碼問題

### Q4：出現 403 Forbidden 錯誤

**症狀**：
- Network 中看到 `transaction-checkout` 請求回傳 403
- Console 顯示權限相關錯誤

**可能原因**：

| 原因 | 環境 | 檢查項目 |
|------|------|---------|
| Token 未正確設置 | All | 檢查 `Paddle.Initialize({ token: '...' })` |
| Domain 未核准 | Production | 檢查 Domain Approval 狀態 |
| Price ID 不屬於該帳號 | All | 確認 Price ID 來自正確的 Paddle 帳號 |

**解決方法**：

1. **Sandbox 環境**：
   - 確認使用 `test_` 開頭的 Token
   - 確認 Price ID 來自 Sandbox Catalog

2. **Production 環境**：
   - 確認使用 `live_` 開頭的 Token
   - 確認 Domain Approval 已通過
   - 確認 Price ID 來自 Production Catalog

---

### Q5：出現 400 Bad Request 錯誤

**症狀**：
- 請求被拒絕，回傳 400 錯誤

**可能原因**：
- 參數格式錯誤
- 缺少必要參數

**解決方法**：

檢查 `Checkout.open()` 的參數格式：

```typescript
// ✅ 正確
Paddle.Checkout.open({
  items: [
    { 
      priceId: 'pri_...', 
      quantity: 1 
    }
  ]
});

// ❌ 錯誤（缺少 items 陣列）
Paddle.Checkout.open({
  priceId: 'pri_...'
});
```

---

## 3️⃣ Webhook 問題

### Q6：Webhook 收不到事件

**症狀**：
- Paddle Simulator 發送測試，但伺服器沒有收到

**檢查清單**：

- [ ] Webhook URL 是否正確（包含 `/api/webhook`）
- [ ] 伺服器是否正在執行（`npm run dev`）
- [ ] Tunnel 工具是否正在執行（localtunnel / ngrok）
- [ ] Tunnel URL 是否已過期（localtunnel 會定期更換）
- [ ] Webhook API 是否正確回傳 200 狀態碼

**手動測試 Webhook**：

在終端機執行以下指令測試本機 API：

```bash
# Windows PowerShell
Invoke-WebRequest -Uri http://localhost:3000/api/webhook -Method POST -ContentType "application/json" -Body '{"alert_name":"subscription_created","test":true}'

# macOS / Linux
curl -X POST http://localhost:3000/api/webhook \
  -H "Content-Type: application/json" \
  -d '{"alert_name":"subscription_created","test":true}'
```

應該回傳：`{"success":true}`

---

### Q7：Webhook 簽章驗證失敗

**症狀**：
- Webhook 收到請求，但簽章驗證失敗

**可能原因**：
- Webhook Secret 設置錯誤
- 簽章驗證邏輯有誤

**解決方法**：

1. **確認 Webhook Secret 正確**：
   ```env
   PADDLE_WEBHOOK_SECRET=你從Dashboard取得的Secret
   ```

2. **參考 Paddle 官方文件**：
   https://developer.paddle.com/webhooks/signature-verification

3. **開發階段可暫時跳過驗證**（僅限 Sandbox）：
   ```typescript
   // ⚠️ 僅供開發測試，生產環境必須驗證！
   if (process.env.NODE_ENV === 'development') {
     // 跳過驗證
   } else {
     // 驗證簽章
   }
   ```

---

### Q8：Webhook 重複接收

**症狀**：
- 同一個事件收到多次

**原因**：
- Paddle 會自動重試失敗的 Webhook
- 如果你的 API 回應時間過長或回傳非 200 狀態碼，Paddle 會重試

**解決方法**：

實作冪等性處理：

```typescript
// 使用資料庫記錄已處理的事件 ID
const eventId = body.event_id || body.p_signature;

// 檢查是否已處理過
const alreadyProcessed = await db.webhookEvents.findOne({ eventId });

if (alreadyProcessed) {
  // 已處理過，直接回傳成功
  return NextResponse.json({ success: true });
}

// 處理事件...

// 記錄為已處理
await db.webhookEvents.create({ eventId, processedAt: new Date() });

return NextResponse.json({ success: true });
```

---

## 4️⃣ 環境切換問題

### Q9：切換到 Production 後無法結帳

**症狀**：
- Sandbox 正常，但切換到 Production 後失敗

**檢查清單**：

- [ ] **Token 已更換**：從 `test_` 改為 `live_`
- [ ] **Price ID 已更換**：使用 Production 環境建立的 Price
- [ ] **Domain Approval 已通過**：Production 環境必須
- [ ] **環境設定已移除**：不要再呼叫 `Paddle.Environment.set('sandbox')`
- [ ] **開發伺服器已重啟**：修改 `.env.local` 後必須重啟

**逐步檢查**：

1. 檢查環境變數：
   ```env
   NEXT_PUBLIC_PADDLE_ENV=production
   NEXT_PUBLIC_PADDLE_CLIENT_TOKEN=live_...
   NEXT_PUBLIC_PADDLE_PRICE_ID=pri_...(正式環境的ID)
   ```

2. 檢查程式碼中是否有硬編碼的 Sandbox 值

3. 清除瀏覽器快取後重新測試

---

### Q10：測試卡號在 Production 無法使用

**症狀**：
- 使用 `4242 4242 4242 4242` 付款失敗

**原因**：
- Production 環境不接受測試卡號

**解決方法**：

1. **使用真實信用卡**進行小額測試（例如 $0.50）

2. **測試完成後申請退款**：
   - Paddle Dashboard → Transactions
   - 找到該筆交易
   - 點擊 Refund

---

## 5️⃣ 付款失敗問題

### Q11：用戶回報付款失敗

**可能原因**：

| 原因 | 檢查方式 |
|------|---------|
| 卡片餘額不足 | 請用戶檢查卡片 |
| 卡片被銀行拒絕 | 請用戶聯絡發卡銀行 |
| 3DS 驗證失敗 | 請用戶完成 3DS 驗證 |
| 網路問題 | 請用戶重試 |
| Paddle 系統問題 | 檢查 Paddle Status Page |

**解決步驟**：

1. **在 Paddle Dashboard 查詢交易記錄**：
   - Transactions → 搜尋用戶郵箱
   - 查看失敗原因

2. **常見拒絕原因**：
   - `insufficient_funds`：餘額不足
   - `card_declined`：卡片被拒
   - `authentication_failed`：3DS 驗證失敗

3. **建議用戶**：
   - 換一張卡片試試
   - 聯絡發卡銀行確認

---

## 6️⃣ 除錯工具與技巧

### 除錯技巧 1：使用瀏覽器開發者工具

**Console 標籤**：
- 查看 JavaScript 錯誤
- 測試 Paddle 物件

**Network 標籤**：
- 查看 API 請求
- 檢查回應狀態碼和內容

**Application 標籤**：
- 查看 Local Storage
- 清除 Cookie

---

### 除錯技巧 2：啟用詳細日誌

在程式碼中加入詳細的 console.log：

```typescript
// PaddleLoader.tsx
onLoad={() => {
  console.log('🔧 Paddle script loaded');
  console.log('🔧 Token:', process.env.NEXT_PUBLIC_PADDLE_CLIENT_TOKEN);
  
  (window as any).Paddle?.Environment?.set('sandbox');
  console.log('🔧 Environment set to sandbox');
  
  (window as any).Paddle?.Initialize?.({ token: '...' });
  console.log('🔧 Paddle initialized');
}}
```

---

### 除錯技巧 3：測試 Paddle 整合

在 Console 手動測試：

```javascript
// 1. 檢查 Paddle 物件是否存在
window.Paddle

// 2. 手動觸發結帳
window.Paddle.Checkout.open({
  items: [{ priceId: 'pri_...', quantity: 1 }]
})

// 3. 檢查環境設定
window.Paddle.Environment
```

---

### 除錯技巧 4：使用 Paddle 官方測試工具

**Paddle Dashboard 的測試功能**：

1. **Webhook Simulator**：
   - Developer Tools → Notifications → Simulations
   - 測試 Webhook 是否正常接收

2. **Transaction Logs**：
   - Transactions 頁面
   - 查看所有交易記錄和失敗原因

---

## 📞 需要更多協助？

如果以上方法都無法解決你的問題：

1. **查閱 Paddle 官方文檔**：
   - https://developer.paddle.com/

2. **聯絡 Paddle 支援**：
   - https://paddle.com/support

3. **提交 Issue 到本專案**：
   - https://github.com/your-username/open-paddle-reference-guides/issues

4. **加入討論區**：
   - https://github.com/your-username/open-paddle-reference-guides/discussions

---

## 🔗 相關文檔

- [01-產品新增指南](./01-產品新增指南.md)
- [02-Paddle平台參數說明](./02-Paddle平台參數說明.md)
- [03-沙盒轉生產環境指南](./03-沙盒轉生產環境指南.md)
- [05-Webhook事件處理指南](./05-Webhook事件處理指南.md)

---

**文檔版本**：v1.0.0  
**最後更新**：2025-10-01  
**實測日期**：2025-09-30

